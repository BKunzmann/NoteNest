FROM node:18-alpine

WORKDIR /app

# Installiere Build-Dependencies für better-sqlite3 und Puppeteer
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# Kopiere Root package.json (Workspace-Konfiguration)
COPY package*.json ./

# Kopiere Backend package.json
COPY backend/package*.json ./backend/

# Kopiere Frontend package.json
COPY frontend/package*.json ./frontend/

# Installiere Dependencies (Workspace-Installation)
RUN npm install

# Copy Entrypoint Script
COPY scripts/docker-entrypoint.js ./scripts/
COPY scripts/docker-entrypoint.sh ./scripts/
RUN chmod +x ./scripts/docker-entrypoint.sh

# Copy .env.example für Entrypoint
COPY .env.example ./.env.example

# Expose Ports
EXPOSE 3000 5173

# Verwende Entrypoint-Script
ENTRYPOINT ["node", "/app/scripts/docker-entrypoint.js"]
# Dev-Command: Starte Backend und Frontend direkt ohne Workspaces
# Verwende tail -f /dev/null um Container am Leben zu halten, falls Command fehlschlägt
CMD ["sh", "-c", "npx concurrently \"cd /app/backend && npm run dev\" \"cd /app/frontend && npm run dev\" || tail -f /dev/null"]

