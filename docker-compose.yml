services:
  notenest:
    # ============================================
    # BUILD-OPTIONEN - WÄHLE EINE:
    # ============================================
    
    # OPTION 1: Lokales Build (für Entwicklung/Testen)
    # Für lokales Testen: Build aktivieren
    build:
      context: .
      dockerfile: Dockerfile
      
    # OPTION 1b: Image verwenden (für Produktion/NAS)
    # Entkommentiere für vorgebautes Image:
    # image: notenest-notenest:latest
    
    # OPTION 2: Image aus Registry (für später, wenn Registry eingerichtet)
    # Entkommentiere diese Zeile und kommentiere "build:" aus:
    # image: notenest:latest
    # Oder mit Registry:
    # image: ghcr.io/BKunzmann/notenest:latest
    # image: docker.io/username/notenest:latest
    
    container_name: notenest
    restart: unless-stopped
    
    # Netzwerk-Port-Mapping
    # Syntax: HOSTPORT:CONTAINERPORT
    # Auf der NAS ist Port 3000 oft schon belegt (z.B. durch andere Apps).
    # Passe daher den linken Wert an einen freien Port an (z.B. 3001).
    # Beispiel: 3001:3000 → außen http://NAS-IP:3001, innen hört die App weiter auf Port 3000.
    ports:
      - "3100:3000"
    
    volumes:
      # ============================================
      # Datenbank (persistent - IMMER aktiviert)
      # ============================================
      - ./data/database:/data/database
      
      # ============================================
      # User-Daten - WÄHLE EINE OPTION:
      # ============================================
      
      # OPTION A: Synology NAS (Standard)
      # Entkommentiere diese Zeilen für Synology NAS:
      # - /volume1/homes:/data/homes:ro      # Private Ordner (read-only für Sicherheit)
      # - /volume1/shared:/data/shared:rw    # Geteilte Ordner (read-write)
      # - /volume1:/data/shared:rw    # Geteilte Ordner (read-write)
      
      # OPTION B: QNAP NAS
      # Entkommentiere diese Zeilen für QNAP:
      # - /share/homes:/data/homes:ro
      # - /share/Public:/data/shared:rw
      
      # OPTION C: Lokale Installation (für Entwicklung/Testen)
      # Für lokales Testen: Lokale Pfade aktivieren
      - ./data/users:/data/users
      - ./data/shared:/data/shared
      
      # ============================================
      # Logs (persistent - IMMER aktiviert)
      # ============================================
      - ./logs:/app/logs
      
      # ============================================
      # Bibel-Daten (optional, read-only)
      # ============================================
      - ./data/bibles:/app/data/bibles:ro # Pfad zu lokalen Bibel-JSON-Dateien
      
      # ============================================
      # .env Datei (wird vom Entrypoint generiert, falls nicht vorhanden)
      # ============================================
      - ./.env:/app/.env
    
    # Umgebungsvariablen für den Container
    # Sicherheitsrelevante und Betriebs-Settings werden über .env gesetzt (siehe .env.example)
    environment:
      - NODE_ENV=development  # Laufzeitumgebung: development für Testen, production für NAS
      - LOG_DIR=/app/logs
    
    env_file:
      - .env
    
    # ============================================
    # Container-User (für Synology NAS-Berechtigungen)
    # ============================================
    # Für lokales Testen: Auskommentieren (läuft als root)
    # Für Synology NAS: Entkommentieren und UID:GID anpassen
    # - Prüfe UID/GID mit: id admin (auf dem NAS)
    # - Standard: 1024:100 (admin:users)
    # user: "1054:100"  # admin:users (Synology Standard)
    
    networks:
      - notenest-network
    
    # Health-Check für automatische Container-Neustarts
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource-Limits (optional, anpassen je nach Server)
    # HINWEIS: Auf vielen NAS-Systemen (z.B. Synology) ist der CPU CFS Scheduler
    # nicht aktiviert. Dann führt das Setzen von CPU-Limits zu Fehlern wie:
    # "NanoCPUs can not be set, as your kernel does not support CPU CFS scheduler"
    # Für solche Systeme die Limits deaktivieren oder nur Memory-Limits verwenden.
    #deploy:
    #  resources:
    #    limits:
    #      cpus: '2'
    #      memory: 2G
    #    reservations:
    #      cpus: '0.5'
    #      memory: 512M

networks:
  notenest-network:
    driver: bridge

